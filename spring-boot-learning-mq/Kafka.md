# Kafka

基于消息的中间件，能够削峰填谷，解耦

## Topic

用于业务拆分，是逻辑概念。

## partition

分区，是Topic的一个子集，是物理概念。



主要用于将一些无关的数据分散到不同的分区中，以增加并发性能。

有关的数据，放到同一个分区。



为了可靠性，partition是支持副本的，但是读写只能发生在主分区上，因为读写分离会产生数据同步不一致的问题。



分区内部是有序的，外部是无序的

一个组内有多个consumer, 但是partition对于一个组，只能有一个consumer去消费，为了保证数据的一致性。

partition中的消息是可以重复消费的。

## Broker



## offset

在consumer消费时，如何保证消息不会漏消费，不会重复消费。

- 重复消费的场景：当消费到一半，consumer宕机了。
- 消息丢失的场景：offset维护成功了，但是业务处理失败回滚了。

所以在运行时，consumer内存里维护了消费的偏移量offset，即消费进度。

offset因为是在内存当中的，为了保证可靠性，在老版本中consumer中的offset会维护在zookeeper当中。

新版本中，kafka是将offset维护到内部的topic的，并持久化到磁盘。

但是offset持久化的策略是什么？

- 异步：会发生延迟，比如说5s，如果在5s内发生kafka故障，offset还未写入，这时候可能会产生重复消费。
- 同步：业务操作和offset的持久化
- 